# ── Modules ───────────────────────────────────────────────────────────────────

# Proxy / PHP-FPM
LoadModule proxy_module         modules/mod_proxy.so
LoadModule proxy_fcgi_module    modules/mod_proxy_fcgi.so
LoadModule proxy_http_module    modules/mod_proxy_http.so

# Essential modules for PrestaShop
LoadModule rewrite_module   modules/mod_rewrite.so
# LoadModule headers_module   modules/mod_headers.so
LoadModule expires_module   modules/mod_expires.so
LoadModule deflate_module   modules/mod_deflate.so
# LoadModule filter_module    modules/mod_filter.so
# LoadModule mime_module      modules/mod_mime.so
# LoadModule setenvif_module  modules/mod_setenvif.so
LoadModule remoteip_module modules/mod_remoteip.so

# ── Server identity & security ────────────────────────────────────────────────
ServerName      webserver
ServerTokens    Prod
ServerSignature Off
TraceEnable     Off

# ── Proxy ─────────────────────────────────────────────────────────────────────
ProxyRequests    Off
ProxyPreserveHost On

<Proxy *>
    Require all granted
</Proxy>

RemoteIPHeader           X-Forwarded-For
RemoteIPInternalProxy    172.16.0.0/12

Timeout      300
ProxyTimeout 300

<IfModule mod_proxy_fcgi.c>
    SetEnv proxy-fcgi-pathinfo    unescape
    SetEnv proxy-initial-not-pooled 1
</IfModule>

# ── Compression (disabled per ENV_PROFILE when set to "local") ────────────────
<IfModule mod_deflate.c>
    # Skip compression for local dev — makes debugging response bodies easier
    <If "%{ENV:ENV_PROFILE} != 'local'">
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
        AddOutputFilterByType DEFLATE application/xml application/xhtml+xml application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript application/x-javascript
        AddOutputFilterByType DEFLATE application/json
        AddOutputFilterByType DEFLATE image/svg+xml
    </If>
</IfModule>

# ── Security headers ──────────────────────────────────────────────────────────
<IfModule mod_headers.c>
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options        "SAMEORIGIN"
    Header always set X-XSS-Protection      "1; mode=block"
    Header always set Referrer-Policy        "no-referrer-when-downgrade"

    # HSTS — only enforce on non-local environments to avoid breaking browser
    # trust for self-signed certs across other local projects
    <If "%{ENV:ENV_PROFILE} != 'local'">
        Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    </If>

    # Remove server fingerprint headers
    Header unset X-Powered-By
    Header unset Server
</IfModule>

# ── Local development overrides ───────────────────────────────────────────────
# Applied when ENV_PROFILE=local (set by init.sh)
<If "%{ENV:ENV_PROFILE} == 'local'">
    # No browser-side caching — every reload hits the server fresh
    <IfModule mod_headers.c>
        Header always set Cache-Control "no-store, no-cache, must-revalidate"
        Header always set Pragma        "no-cache"
    </IfModule>

    # Verbose logging for local debugging
    LogLevel warn proxy_fcgi:trace2
</If>

# ── Limits & keep-alive (production defaults) ─────────────────────────────────
LimitRequestBody     104857600

KeepAlive            On
MaxKeepAliveRequests 100
KeepAliveTimeout     5
