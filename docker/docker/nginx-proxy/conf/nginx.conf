# Worker count matches CPU core count automatically
worker_processes auto;

# Max open file descriptors per worker (should be >= worker_connections)
worker_rlimit_nofile 100000;

error_log /var/log/nginx/error.log warn;

events {
    # Max simultaneous connections per worker.
    # Total max clients = worker_connections * worker_processes
    worker_connections 4000;

    # Linux-optimised event model — good for local dev too
    use epoll;

    # Accept all pending connections at once instead of one per event loop
    multi_accept on;
}

pid /var/run/nginx.pid;

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Cache open file descriptors / metadata to reduce syscall overhead
    open_file_cache          max=1000 inactive=20s;   # lower limit suits local dev
    open_file_cache_valid    30s;
    open_file_cache_min_uses 2;
    open_file_cache_errors   on;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    # Zero-copy file transfer (kernel space)
    sendfile    on;
    # Batch TCP packets with full MSS before sending (requires sendfile on)
    tcp_nopush  on;
    # Disable Nagle — send small packets immediately (good for proxied apps)
    tcp_nodelay on;

    # Gzip compression
    gzip              on;
    gzip_min_length   1024;   # skip tiny responses — not worth the CPU cost
    gzip_comp_level   4;      # balanced: level 1 is too weak, 6+ is too slow for local
    gzip_vary         on;     # add Vary: Accept-Encoding header
    gzip_disable      "msie6";
    gzip_proxied      expired no-cache no-store private auth;
    gzip_types
        text/css
        text/javascript
        text/xml
        text/plain
        text/x-component
        application/javascript
        application/x-javascript
        application/json
        application/xml
        application/rss+xml
        application/atom+xml
        font/truetype
        font/opentype
        application/vnd.ms-fontobject
        image/svg+xml;

    # SSL global settings (used by all SSL server blocks)
    ssl_protocols             TLSv1.2 TLSv1.3;
    ssl_prefer_server_ciphers on;
    ssl_ciphers               ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305;
    ssl_session_cache         shared:SSL:10m;   # ~40k sessions
    ssl_session_timeout       1d;
    ssl_session_tickets       off;              # forward secrecy

    # Free up memory when clients stop responding
    reset_timedout_connection on;

    client_body_timeout  60s;
    send_timeout         60s;
    keepalive_timeout    65s;
    keepalive_requests   1000;

    client_max_body_size 100M;

    # Buffer sizes for large headers / upstream responses
    proxy_buffer_size           32k;
    proxy_buffers               8 32k;
    large_client_header_buffers 4 32k;

    include /etc/nginx/conf.d/*.conf;
}
